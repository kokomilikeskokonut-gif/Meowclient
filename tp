game:GetService("RunService").RenderStepped:Connect(function()
    local cam = workspace.CurrentCamera
    local UIS = game:GetService("UserInputService")
    local lp = game.Players.LocalPlayer
    local char = lp.Character

    -- ... [Keep Aimbot/Triggerbot/ESP code here] ...

    if Settings.Freecam then
        -- Freecam Logic
        if not LastFreecamState then
            local rx, ry, _ = cam.CFrame:ToOrientation()
            FreecamRotX, FreecamRotY, LastFreecamState = rx, ry, true
        end
        UIS.MouseBehavior = Enum.MouseBehavior.LockCenter
        cam.CameraType = Enum.CameraType.Scriptable
        
        local delta = UIS:GetMouseDelta()
        FreecamRotY = FreecamRotY - (delta.X * 0.005)
        FreecamRotX = math.clamp(FreecamRotX - (delta.Y * 0.005), -1.5, 1.5)
        local newRotCFrame = CFrame.fromOrientation(FreecamRotX, FreecamRotY, 0)
        
        local moveDir = Vector3.new(0,0,0)
        if UIS:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + newRotCFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - newRotCFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + newRotCFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - newRotCFrame.RightVector end
        cam.CFrame = CFrame.new(cam.CFrame.Position + (moveDir * Settings.FreecamSpeed)) * newRotCFrame
    
    elseif Settings.SpectateEnabled and Settings.SpectateTarget then
        -- Spectate Logic
        cam.CameraType = Enum.CameraType.Custom
        local targetChar = Settings.SpectateTarget.Character
        local targetHum = targetChar and targetChar:FindFirstChild("Humanoid")
        
        if targetHum then
            if cam.CameraSubject ~= targetHum then
                cam.CameraSubject = targetHum
            end
        else
            -- If target dies or is nil, return to local player
            cam.CameraSubject = char:FindFirstChild("Humanoid")
        end
    else
        -- Normal Camera Logic
        LastFreecamState = false
        if cam.CameraType == Enum.CameraType.Scriptable then 
            cam.CameraType = Enum.CameraType.Custom 
            UIS.MouseBehavior = Enum.MouseBehavior.Default
        end
        if char and char:FindFirstChild("Humanoid") and cam.CameraSubject ~= char.Humanoid then
            cam.CameraSubject = char.Humanoid
        end
    end
end)
